#Область ПрограммныйИнтерфейс

// Выполняет автоматическую оптимизацию рациона кормления
//
// Параметры:
//  ДанныеРациона - Структура - данные рациона для оптимизации:
//   * Дата - Дата - дата рациона
//   * ГруппаЖивотных - СправочникСсылка.ГруппыЖивотных - группа животных
//   * ТаблицаКормов - ТаблицаЗначений - таблица кормов с диапазонами веса
//   * ТаблицаПоказателей - ТаблицаЗначений - нормативные показатели
//
// Возвращаемое значение:
//   Структура - результат оптимизации:
//    * Успех - Булево - признак успешного завершения
//    * ТаблицаКормов - ТаблицаЗначений - таблица с рассчитанными весами
//    * КоличествоПоказателейВнеНормы - Число - количество показателей вне нормы
//    * ОбщееКоличествоПоказателей - Число - общее количество показателей
//    * ВремяРасчета - Число - время расчета в секундах
//    * ТекстОшибки - Строка - текст ошибки при неуспехе
//
Функция ВыполнитьАвтоматическуюОптимизацию(ДанныеРациона) Экспорт
	
	ВремяНачала = ТекущаяУниверсальнаяДатаВМиллисекундах();
	МаксимальноеВремяРасчета = 30000; // 30 секунд в миллисекундах
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("ТаблицаКормов", Неопределено);
	Результат.Вставить("КоличествоПоказателейВнеНормы", 0);
	Результат.Вставить("ОбщееКоличествоПоказателей", 0);
	Результат.Вставить("ВремяРасчета", 0);
	Результат.Вставить("ТекстОшибки", "");
	
	Попытка
		
		// Шаг 1: Подготовка входных данных
		ДанныеДляОптимизации = ПодготовитьДанныеДляОптимизации(ДанныеРациона);
		Если ДанныеДляОптимизации.ЕстьОшибка Тогда
			Результат.ТекстОшибки = ДанныеДляОптимизации.ТекстОшибки;
			Возврат Результат;
		КонецЕсли;
		
		// Шаг 2: Выполнение оптимизации
		РезультатОптимизации = ВыполнитьОптимизациюПокоординатнымСпуском(
			ДанныеДляОптимизации, 
			ВремяНачала, 
			МаксимальноеВремяРасчета);
		
		// Шаг 3: Применение результата
		Если РезультатОптимизации.НайденоРешение Тогда
			
			// Обновление таблицы кормов с рассчитанными весами
			ТаблицаКормов = ДанныеРациона.ТаблицаКормов.Скопировать();
			Для Индекс = 0 По РезультатОптимизации.ВесаКормов.ВГраница() Цикл
				ТаблицаКормов[Индекс].Вес = РезультатОптимизации.ВесаКормов[Индекс];
			КонецЦикла;
			
			// Оценка качества решения
			ОценкаРешения = ОценитьРешение(РезультатОптимизации.ВесаКормов, ДанныеДляОптимизации);
			
			Результат.Успех = Истина;
			Результат.ТаблицаКормов = ТаблицаКормов;
			Результат.КоличествоПоказателейВнеНормы = ОценкаРешения.КоличествоПоказателейВнеНормы;
			Результат.ОбщееКоличествоПоказателей = ОценкаРешения.ОбщееКоличествоПоказателей;
			Результат.ВремяРасчета = (ТекущаяУниверсальнаяДатаВМиллисекундах() - ВремяНачала) / 1000;
			
		Иначе
			Результат.ТекстОшибки = "Не удалось найти решение. Попробуйте изменить диапазоны веса кормов.";
		КонецЕсли;
		
	Исключение
		Результат.ТекстОшибки = СтрШаблон("Ошибка при выполнении оптимизации: %1", ОписаниеОшибки());
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Подготавливает данные для оптимизации
//
// Параметры:
//  ДанныеРациона - Структура - исходные данные рациона
//
// Возвращаемое значение:
//   Структура - подготовленные данные:
//    * ЕстьОшибка - Булево - признак ошибки
//    * ТекстОшибки - Строка - текст ошибки
//    * КоличествоКормов - Число - количество кормов
//    * МинимальныеВеса - Массив из Число - минимальные веса кормов
//    * МаксимальныеВеса - Массив из Число - максимальные веса кормов
//    * НачальныеВеса - Массив из Число - начальные веса (средние значения)
//    * МассивНоменклатуры - Массив - массив номенклатуры кормов
//    * МассивВидовКорма - Массив - массив видов кормов
//    * ТаблицаПитательности - ТаблицаЗначений - показатели питательности кормов
//    * МассивПоказателей - Массив - массив показателей для оптимизации
//    * СоответствиеПриоритетов - Соответствие - приоритеты показателей
//
Функция ПодготовитьДанныеДляОптимизации(ДанныеРациона)
	
	Результат = Новый Структура;
	Результат.Вставить("ЕстьОшибка", Ложь);
	Результат.Вставить("ТекстОшибки", "");
	Результат.Вставить("КоличествоКормов", 0);
	Результат.Вставить("МинимальныеВеса", Новый Массив);
	Результат.Вставить("МаксимальныеВеса", Новый Массив);
	Результат.Вставить("НачальныеВеса", Новый Массив);
	Результат.Вставить("МассивНоменклатуры", Новый Массив);
	Результат.Вставить("МассивВидовКорма", Новый Массив);
	Результат.Вставить("ТаблицаПитательности", Неопределено);
	Результат.Вставить("МассивПоказателей", Новый Массив);
	Результат.Вставить("СоответствиеПриоритетов", Новый Соответствие);
	
	ТаблицаКормов = ДанныеРациона.ТаблицаКормов;
	
	// Проверка наличия кормов
	Если ТаблицаКормов.Количество() = 0 Тогда
		Результат.ЕстьОшибка = Истина;
		Результат.ТекстОшибки = "Не указаны корма в рационе.";
		Возврат Результат;
	КонецЕсли;
	
	// Сбор данных по кормам
	Для каждого СтрокаКорма Из ТаблицаКормов Цикл
		Результат.МинимальныеВеса.Добавить(СтрокаКорма.МинимальныйВес);
		Результат.МаксимальныеВеса.Добавить(СтрокаКорма.МаксимальныйВес);
		// Начальное значение - среднее между мин и макс
		НачальныйВес = (СтрокаКорма.МинимальныйВес + СтрокаКорма.МаксимальныйВес) / 2;
		Результат.НачальныеВеса.Добавить(НачальныйВес);
		Результат.МассивНоменклатуры.Добавить(СтрокаКорма.Номенклатура);
		Результат.МассивВидовКорма.Добавить(СтрокаКорма.ВидКорма);
	КонецЦикла;
	
	Результат.КоличествоКормов = ТаблицаКормов.Количество();
	
	// Получение показателей питательности кормов
	Результат.ТаблицаПитательности = ПолучитьТаблицуПитательностиКормов(
		ДанныеРациона.Дата, 
		Результат.МассивНоменклатуры);
	
	// Проверка наличия данных по питательности
	Если Результат.ТаблицаПитательности.Количество() < Результат.КоличествоКормов Тогда
		Результат.ЕстьОшибка = Истина;
		Результат.ТекстОшибки = "Для некоторых кормов не заполнены показатели питательности.";
		Возврат Результат;
	КонецЕсли;
	
	// Подготовка показателей для оптимизации с приоритетами
	Результат.МассивПоказателей = ПодготовитьМассивПоказателей(ДанныеРациона.ТаблицаПоказателей);
	Результат.СоответствиеПриоритетов = ПолучитьСоответствиеПриоритетовПоказателей();
	
	// Проверка наличия нормативных показателей
	Если Результат.МассивПоказателей.Количество() = 0 Тогда
		Результат.ЕстьОшибка = Истина;
		Результат.ТекстОшибки = "Не заполнены нормативные показатели рациона.";
		Возврат Результат;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Получает таблицу питательности кормов из регистра сведений
//
// Параметры:
//  Дата - Дата - дата среза
//  МассивНоменклатуры - Массив - массив номенклатуры кормов
//
// Возвращаемое значение:
//   ТаблицаЗначений - таблица с показателями питательности
//
Функция ПолучитьТаблицуПитательностиКормов(Дата, МассивНоменклатуры)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТаблицаПитательности.Номенклатура КАК Номенклатура,
	|	ТаблицаПитательности.СухоеВещество КАК СухоеВещество,
	|	ТаблицаПитательности.ОЭ КАК ОЭ,
	|	ТаблицаПитательности.XP КАК XP,
	|	ТаблицаПитательности.nXp КАК nXp,
	|	ТаблицаПитательности.RNB КАК RNB,
	|	ТаблицаПитательности.СК КАК СК,
	|	ТаблицаПитательности.СЖ КАК СЖ,
	|	ТаблицаПитательности.СЗ КАК СЗ,
	|	ТаблицаПитательности.Крахмал КАК Крахмал,
	|	ТаблицаПитательности.ТранзитныйКрахмал КАК ТранзитныйКрахмал,
	|	ТаблицаПитательности.Сахар КАК Сахар,
	|	ТаблицаПитательности.NDF КАК NDF,
	|	ТаблицаПитательности.ADF КАК ADF,
	|	ТаблицаПитательности.NEL КАК NEL,
	|	ТаблицаПитательности.Ca КАК Ca,
	|	ТаблицаПитательности.Na КАК Na,
	|	ТаблицаПитательности.Mg КАК Mg,
	|	ТаблицаПитательности.K КАК K,
	|	ТаблицаПитательности.Cl КАК Cl,
	|	ТаблицаПитательности.S КАК S,
	|	ТаблицаПитательности.P КАК P,
	|	ТаблицаПитательности.Структ КАК Структ,
	|	ТаблицаПитательности.СтрКл КАК СтрКл,
	|	ТаблицаПитательности.РастворимыйСП КАК РастворимыйСП,
	|	ТаблицаПитательности.РастворимыйВРубцеПротеин КАК РастворимыйВРубцеПротеин,
	|	ТаблицаПитательности.НерастворимыйВРубцеПротеин КАК НерастворимыйВРубцеПротеин,
	|	ТаблицаПитательности.UDP КАК UDP,
	|	ТаблицаПитательности.ADL КАК ADL
	|ИЗ
	|	РегистрСведений.ТаблицаПитательностиКормов.СрезПоследних(&Дата, Номенклатура В (&МассивНоменклатуры)) КАК ТаблицаПитательности";
	
	Запрос.УстановитьПараметр("Дата", Дата);
	Запрос.УстановитьПараметр("МассивНоменклатуры", МассивНоменклатуры);
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

// Подготавливает массив показателей для оптимизации
//
// Параметры:
//  ТаблицаПоказателей - ТаблицаЗначений - таблица нормативных показателей
//
// Возвращаемое значение:
//   Массив из Структура - массив показателей с параметрами
//
Функция ПодготовитьМассивПоказателей(ТаблицаПоказателей)
	
	МассивПоказателей = Новый Массив;
	
	Для каждого СтрокаПоказателя Из ТаблицаПоказателей Цикл
		
		Если НЕ ЗначениеЗаполнено(СтрокаПоказателя.ПоказательРациона) Тогда
			Продолжить;
		КонецЕсли;
		
		Показатель = Новый Структура;
		Показатель.Вставить("ПоказательРациона", СтрокаПоказателя.ПоказательРациона);
		Показатель.Вставить("ИмяПредопределенныхДанных", СтрокаПоказателя.ПоказательРациона.ИмяПредопределенныхДанных);
		Показатель.Вставить("ЕдиницаИзмерения", СтрокаПоказателя.ЕдиницаИзмерения);
		Показатель.Вставить("Минимум", СтрокаПоказателя.Минимум);
		Показатель.Вставить("Максимум", СтрокаПоказателя.Максимум);
		
		// Применяем погрешность -5% к нижней границе
		Если ЗначениеЗаполнено(Показатель.Минимум) Тогда
			Показатель.Вставить("МинимумСПогрешностью", Показатель.Минимум * 0.95);
		Иначе
			Показатель.Вставить("МинимумСПогрешностью", 0);
		КонецЕсли;
		
		МассивПоказателей.Добавить(Показатель);
		
	КонецЦикла;
	
	Возврат МассивПоказателей;
	
КонецФункции

// Возвращает соответствие приоритетов показателей
//
// Возвращаемое значение:
//   Соответствие - соответствие имени показателя и его приоритета (меньше - выше)
//
Функция ПолучитьСоответствиеПриоритетовПоказателей()
	
	Приоритеты = Новый Соответствие;
	
	// Приоритет показателей согласно брифу
	Приоритеты.Вставить("СухоеВещество", 1); // Наивысший приоритет
	Приоритеты.Вставить("XP", 2); // СП (сырой протеин)
	Приоритеты.Вставить("СВВОК", 3); // СВ в ОК
	Приоритеты.Вставить("Влажность", 4);
	
	// Остальные показатели имеют низкий приоритет
	// (по умолчанию будет использоваться значение 99)
	
	Возврат Приоритеты;
	
КонецФункции

// Выполняет оптимизацию методом покоординатного спуска
//
// Параметры:
//  ДанныеДляОптимизации - Структура - подготовленные данные
//  ВремяНачала - Число - время начала в миллисекундах
//  МаксимальноеВремяРасчета - Число - максимальное время в миллисекундах
//
// Возвращаемое значение:
//   Структура - результат оптимизации:
//    * НайденоРешение - Булево - признак найденного решения
//    * ВесаКормов - Массив из Число - оптимальные веса кормов
//
Функция ВыполнитьОптимизациюПокоординатнымСпуском(ДанныеДляОптимизации, ВремяНачала, МаксимальноеВремяРасчета)
	
	Результат = Новый Структура;
	Результат.Вставить("НайденоРешение", Ложь);
	Результат.Вставить("ВесаКормов", Новый Массив);
	
	// Инициализация весов средними значениями
	ТекущиеВеса = Новый Массив;
	Для каждого Вес Из ДанныеДляОптимизации.НачальныеВеса Цикл
		ТекущиеВеса.Добавить(Вес);
	КонецЦикла;
	
	ЛучшиеВеса = СкопироватьМассив(ТекущиеВеса);
	ЛучшаяОценка = ВычислитьЦелевуюФункцию(ТекущиеВеса, ДанныеДляОптимизации);
	
	// Параметры оптимизации
	МаксимальноеКоличествоИтераций = 100;
	ШагИзменения = 0.1; // 100 грамм
	МинимальныйШаг = 0.01; // 10 грамм
	
	// Сортировка показателей по приоритету
	МассивПоказателейПоПриоритету = СортироватьПоказателиПоПриоритету(
		ДанныеДляОптимизации.МассивПоказателей, 
		ДанныеДляОптимизации.СоответствиеПриоритетов);
	
	// Итерационная оптимизация
	Для НомерИтерации = 1 По МаксимальноеКоличествоИтераций Цикл
		
		// Проверка таймаута
		Если ТекущаяУниверсальнаяДатаВМиллисекундах() - ВремяНачала > МаксимальноеВремяРасчета Тогда
			Прервать;
		КонецЕсли;
		
		БылоУлучшение = Ложь;
		
		// Оптимизация по каждому приоритетному показателю
		Для каждого Показатель Из МассивПоказателейПоПриоритету Цикл
			
			// Оптимизация веса каждого корма для текущего показателя
			Для ИндексКорма = 0 По ДанныеДляОптимизации.КоличествоКормов - 1 Цикл
				
				// Проверка таймаута
				Если ТекущаяУниверсальнаяДатаВМиллисекундах() - ВремяНачала > МаксимальноеВремяРасчета Тогда
					Прервать;
				КонецЕсли;
				
				МинВес = ДанныеДляОптимизации.МинимальныеВеса[ИндексКорма];
				МаксВес = ДанныеДляОптимизации.МаксимальныеВеса[ИндексКорма];
				ТекущийВес = ТекущиеВеса[ИндексКорма];
				
				// Пробуем изменить вес в обе стороны
				НаправленияИзменения = Новый Массив;
				НаправленияИзменения.Добавить(1); // Увеличение
				НаправленияИзменения.Добавить(-1); // Уменьшение
				
				Для каждого Направление Из НаправленияИзменения Цикл
					
					НовыйВес = ТекущийВес + Направление * ШагИзменения;
					
					// Проверка границ
					Если НовыйВес < МинВес ИЛИ НовыйВес > МаксВес Тогда
						Продолжить;
					КонецЕсли;
					
					// Применяем новый вес
					НовыеВеса = СкопироватьМассив(ТекущиеВеса);
					НовыеВеса[ИндексКорма] = НовыйВес;
					
					// Оцениваем новое решение
					НоваяОценка = ВычислитьЦелевуюФункцию(НовыеВеса, ДанныеДляОптимизации);
					
					// Если решение лучше, принимаем его
					Если НоваяОценка < ЛучшаяОценка Тогда
						ТекущиеВеса = НовыеВеса;
						ЛучшиеВеса = СкопироватьМассив(ТекущиеВеса);
						ЛучшаяОценка = НоваяОценка;
						БылоУлучшение = Истина;
					КонецЕсли;
					
				КонецЦикла;
				
			КонецЦикла;
			
		КонецЦикла;
		
		// Если не было улучшения, уменьшаем шаг
		Если НЕ БылоУлучшение Тогда
			ШагИзменения = ШагИзменения / 2;
			Если ШагИзменения < МинимальныйШаг Тогда
				Прервать; // Достигнута минимальная точность
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	Результат.НайденоРешение = Истина;
	Результат.ВесаКормов = ЛучшиеВеса;
	
	Возврат Результат;
	
КонецФункции

// Вычисляет целевую функцию (взвешенную сумму отклонений от нормативов)
//
// Параметры:
//  ВесаКормов - Массив из Число - веса кормов
//  ДанныеДляОптимизации - Структура - данные для оптимизации
//
// Возвращаемое значение:
//   Число - значение целевой функции (меньше - лучше)
//
Функция ВычислитьЦелевуюФункцию(ВесаКормов, ДанныеДляОптимизации)
	
	// Рассчитываем показатели питательности для текущих весов
	ПоказателиПитательности = РассчитатьПоказателиПитательности(ВесаКормов, ДанныеДляОптимизации);
	
	// Вычисляем отклонения от нормативов с учетом приоритетов
	СуммаОтклонений = 0;
	
	Для каждого Показатель Из ДанныеДляОптимизации.МассивПоказателей Цикл
		
		ИмяПоказателя = Показатель.ИмяПредопределенныхДанных;
		ФактическоеЗначение = ПоказателиПитательности[ИмяПоказателя];
		
		// Вычисляем отклонение от диапазона
		Отклонение = 0;
		
		Если ЗначениеЗаполнено(Показатель.Минимум) И ФактическоеЗначение < Показатель.МинимумСПогрешностью Тогда
			// Ниже минимума с учетом погрешности
			Отклонение = Показатель.МинимумСПогрешностью - ФактическоеЗначение;
		ИначеЕсли ЗначениеЗаполнено(Показатель.Максимум) И ФактическоеЗначение > Показатель.Максимум Тогда
			// Выше максимума
			Отклонение = ФактическоеЗначение - Показатель.Максимум;
		КонецЕсли;
		
		// Получаем приоритет показателя
		Приоритет = ДанныеДляОптимизации.СоответствиеПриоритетов[ИмяПоказателя];
		Если Приоритет = Неопределено Тогда
			Приоритет = 99; // Низкий приоритет по умолчанию
		КонецЕсли;
		
		// Коэффициент приоритета (чем выше приоритет, тем больше штраф)
		КоэффициентПриоритета = 100 / Приоритет;
		
		// Добавляем взвешенное отклонение
		СуммаОтклонений = СуммаОтклонений + Отклонение * КоэффициентПриоритета;
		
	КонецЦикла;
	
	Возврат СуммаОтклонений;
	
КонецФункции

// Рассчитывает показатели питательности для заданных весов кормов
//
// Параметры:
//  ВесаКормов - Массив из Число - веса кормов
//  ДанныеДляОптимизации - Структура - данные для оптимизации
//
// Возвращаемое значение:
//   Структура - рассчитанные показатели питательности
//
Функция РассчитатьПоказателиПитательности(ВесаКормов, ДанныеДляОптимизации)
	
	Показатели = Новый Структура;
	
	// Общий вес рациона в граммах
	ОбщийВес = 0;
	Для каждого Вес Из ВесаКормов Цикл
		ОбщийВес = ОбщийВес + Вес * 1000;
	КонецЦикла;
	
	// Инициализация показателей
	СуммаСВ = 0;
	СуммаСВ_ОК = 0;
	
	// Таблица для хранения сумм по показателям
	СуммыПоказателей = Новый Соответствие;
	
	// Расчет показателей на основе весов и питательности кормов
	Для Индекс = 0 По ДанныеДляОптимизации.КоличествоКормов - 1 Цикл
		
		Номенклатура = ДанныеДляОптимизации.МассивНоменклатуры[Индекс];
		ВидКорма = ДанныеДляОптимизации.МассивВидовКорма[Индекс];
		Вес = ВесаКормов[Индекс];
		
		// Находим питательность корма
		НайденнаяСтрока = ДанныеДляОптимизации.ТаблицаПитательности.Найти(Номенклатура, "Номенклатура");
		Если НайденнаяСтрока = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		// Сухое вещество
		СухоеВещество = НайденнаяСтрока.СухоеВещество;
		ДоляСВ = Вес * СухоеВещество / 1000;
		СуммаСВ = СуммаСВ + ДоляСВ;
		
		Если ВидКорма = Перечисления.ВидыКормов.ОК Тогда
			СуммаСВ_ОК = СуммаСВ_ОК + ДоляСВ;
		КонецЕсли;
		
		// Расчет остальных показателей
		Для каждого Колонка Из ДанныеДляОптимизации.ТаблицаПитательности.Колонки Цикл
			
			ИмяКолонки = Колонка.Имя;
			Если ИмяКолонки = "Номенклатура" ИЛИ ИмяКолонки = "СухоеВещество" Тогда
				Продолжить;
			КонецЕсли;
			
			ЗначениеПитательности = НайденнаяСтрока[ИмяКолонки];
			ТекЗначение = Вес * ЗначениеПитательности * СухоеВещество / 1000;
			
			Если СуммыПоказателей[ИмяКолонки] = Неопределено Тогда
				СуммыПоказателей.Вставить(ИмяКолонки, 0);
			КонецЕсли;
			
			СуммыПоказателей[ИмяКолонки] = СуммыПоказателей[ИмяКолонки] + ТекЗначение;
			
		КонецЦикла;
		
	КонецЦикла;
	
	// Формируем результирующую структуру показателей
	Показатели.Вставить("СухоеВещество", СуммаСВ);
	Показатели.Вставить("СВВОК", СуммаСВ_ОК);
	Показатели.Вставить("Влажность", ОбщийВес - СуммаСВ);
	
	// Переносим остальные показатели
	Для каждого КлючЗначение Из СуммыПоказателей Цикл
		Показатели.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
	КонецЦикла;
	
	// Расчет производных показателей в процентах
	Если СуммаСВ > 0 Тогда
		
		// СВВОК в процентах
		Если Показатели.Свойство("СВВОК") Тогда
			Показатели.СВВОК = 100 * СуммаСВ_ОК / СуммаСВ;
		КонецЕсли;
		
		// Влажность в процентах
		Если Показатели.Свойство("Влажность") И ОбщийВес > 0 Тогда
			Показатели.Влажность = 100 - 100 * СуммаСВ / ОбщийВес;
		КонецЕсли;
		
		// Остальные показатели в процентах
		Для каждого КлючЗначение Из СуммыПоказателей Цикл
			ИмяПоказателя = КлючЗначение.Ключ;
			// Проверяем, нужно ли переводить в проценты (это должно быть в метаданных показателя)
			// Для упрощения пока все показатели, кроме базовых, оставляем как есть
		КонецЦикла;
		
	КонецЕсли;
	
	Возврат Показатели;
	
КонецФункции

// Оценивает качество найденного решения
//
// Параметры:
//  ВесаКормов - Массив из Число - веса кормов
//  ДанныеДляОптимизации - Структура - данные для оптимизации
//
// Возвращаемое значение:
//   Структура - оценка решения:
//    * КоличествоПоказателейВнеНормы - Число - количество показателей вне нормы
//    * ОбщееКоличествоПоказателей - Число - общее количество показателей
//
Функция ОценитьРешение(ВесаКормов, ДанныеДляОптимизации)
	
	Результат = Новый Структура;
	Результат.Вставить("КоличествоПоказателейВнеНормы", 0);
	Результат.Вставить("ОбщееКоличествоПоказателей", 0);
	
	// Рассчитываем показатели питательности
	ПоказателиПитательности = РассчитатьПоказателиПитательности(ВесаКормов, ДанныеДляОптимизации);
	
	// Проверяем каждый показатель
	Для каждого Показатель Из ДанныеДляОптимизации.МассивПоказателей Цикл
		
		Результат.ОбщееКоличествоПоказателей = Результат.ОбщееКоличествоПоказателей + 1;
		
		ИмяПоказателя = Показатель.ИмяПредопределенныхДанных;
		ФактическоеЗначение = ПоказателиПитательности[ИмяПоказателя];
		
		ВнеНормы = Ложь;
		
		Если ЗначениеЗаполнено(Показатель.Минимум) И ФактическоеЗначение < Показатель.МинимумСПогрешностью Тогда
			ВнеНормы = Истина;
		ИначеЕсли ЗначениеЗаполнено(Показатель.Максимум) И ФактическоеЗначение > Показатель.Максимум Тогда
			ВнеНормы = Истина;
		КонецЕсли;
		
		Если ВнеНормы Тогда
			Результат.КоличествоПоказателейВнеНормы = Результат.КоличествоПоказателейВнеНормы + 1;
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

// Сортирует показатели по приоритету
//
// Параметры:
//  МассивПоказателей - Массив - массив показателей
//  СоответствиеПриоритетов - Соответствие - приоритеты показателей
//
// Возвращаемое значение:
//   Массив - отсортированный массив показателей
//
Функция СортироватьПоказателиПоПриоритету(МассивПоказателей, СоответствиеПриоритетов)
	
	// Создаем таблицу для сортировки
	ТаблицаСортировки = Новый ТаблицаЗначений;
	ТаблицаСортировки.Колонки.Добавить("Показатель");
	ТаблицаСортировки.Колонки.Добавить("Приоритет", Новый ОписаниеТипов("Число"));
	
	Для каждого Показатель Из МассивПоказателей Цикл
		НоваяСтрока = ТаблицаСортировки.Добавить();
		НоваяСтрока.Показатель = Показатель;
		
		Приоритет = СоответствиеПриоритетов[Показатель.ИмяПредопределенныхДанных];
		Если Приоритет = Неопределено Тогда
			Приоритет = 99;
		КонецЕсли;
		
		НоваяСтрока.Приоритет = Приоритет;
	КонецЦикла;
	
	ТаблицаСортировки.Сортировать("Приоритет");
	
	РезультатМассив = Новый Массив;
	Для каждого Строка Из ТаблицаСортировки Цикл
		РезультатМассив.Добавить(Строка.Показатель);
	КонецЦикла;
	
	Возврат РезультатМассив;
	
КонецФункции

// Копирует массив
//
// Параметры:
//  ИсходныйМассив - Массив - исходный массив
//
// Возвращаемое значение:
//   Массив - копия массива
//
Функция СкопироватьМассив(ИсходныйМассив)
	
	НовыйМассив = Новый Массив;
	Для каждого Элемент Из ИсходныйМассив Цикл
		НовыйМассив.Добавить(Элемент);
	КонецЦикла;
	
	Возврат НовыйМассив;
	
КонецФункции

#КонецОбласти
