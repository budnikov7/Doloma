# Рекомендации по изменению метаданных и форм

## Дата создания: 2026-01-18

---

## 1. Справочник `Рационы` - Форма элемента (`ФормаЭлемента`)

### 1.1. Добавить команду "РассчитатьАвтоматически"

**Расположение:** Панель команд формы (CommandBar)

**Свойства команды:**
- **Имя:** `РассчитатьАвтоматически`
- **Заголовок:** `Авторасчет` или `Рассчитать автоматически`
- **Картинка:** Рекомендуется иконка калькулятора или магической палочки
- **Группа:** `ФормаКоманднаяПанель` (рядом с кнопкой "Рассчитать")
- **Действие:** Вызов процедуры `РассчитатьАвтоматически` (уже реализована в модуле формы)
- **Отображение:** `Кнопка` или `КнопкаИТекст`

**Видимость:**
- Команда должна быть доступна только пользователям с ролями:
  - `ПолныеПрава`
  - `Зоотехник`

**Подсказка (Tooltip):**
```
Автоматический расчет количества кормов для балансировки показателей питательности в пределах нормативных значений
```

---

## 2. Справочник `Рационы` - Табличная часть `Корма`

### 2.1. Проверить наличие реквизитов

Убедиться, что в табличной части `Корма` существуют следующие реквизиты:

- **МинимальныйВес** (Число, 10.3, не отрицательное)
  - Заголовок: `Мин. вес, кг`
  - Тип: `ОпределяемыйТип.ПоказательПитательности` или `Число(10,3)`
  
- **МаксимальныйВес** (Число, 10.3, не отрицательное)
  - Заголовок: `Макс. вес, кг`
  - Тип: `ОпределяемыйТип.ПоказательПитательности` или `Число(10,3)`

**Примечание:** Согласно метаданным (Рационы.mdo), эти реквизиты уже существуют. Необходимо проверить их отображение в форме.

### 2.2. Настроить отображение колонок в форме

В форме элемента в таблице `Корма` должны быть видимы следующие колонки в таком порядке:

1. Номенклатура
2. Вид корма
3. **Мин. вес** (МинимальныйВес)
4. **Вес, кг** (Вес) - текущее значение, которое будет изменено авторасчетом
5. **Макс. вес** (МаксимальныйВес)
6. Цена, руб
7. Сумма, руб
8. Доля СВ, кг
9. %
10. % СВ

**Рекомендация:** Сделать колонки МинимальныйВес и МаксимальныйВес редактируемыми, выделить их цветом (например, светло-желтым фоном) для визуального указания, что это входные параметры для авторасчета.

---

## 3. Общий модуль `РасчетРационов`

### 3.1. Свойства модуля

Убедиться, что у общего модуля `РасчетРационов` установлены следующие свойства:

- **Сервер:** `Да` ✓
- **Внешнее соединение:** `Да` (опционально)
- **Глобальный:** `Нет`
- **Клиент (управляемое приложение):** `Нет`
- **Клиент (обычное приложение):** `Нет`
- **Привилегированный:** `Нет`

**Примечание:** Эти настройки уже должны быть установлены по умолчанию.

---

## 4. Регистр сведений `НормативныеПоказателиРационов`

### 4.1. Проверить структуру

Убедиться, что регистр содержит следующие реквизиты:

**Измерения:**
- `ГруппаЖивотных` (СправочникСсылка.ГруппыЖивотных)
- `ПоказательРациона` (СправочникСсылка.ПоказателиРационов)

**Ресурсы:**
- `ЕдиницаИзмерения` (СправочникСсылка.ЕдиницыИзмерения)
- `Минимум` (Число)
- `Максимум` (Число)
- `ПоказыватьВРационе` (Булево)

---

## 5. Регистр сведений `ТаблицаПитательностиКормов`

### 5.1. Проверить структуру

Убедиться, что регистр содержит все необходимые показатели питательности:

**Измерения:**
- `Номенклатура` (СправочникСсылка.Номенклатура)
- `Период` (Дата)

**Ресурсы (минимальный набор):**
- `СухоеВещество` (Число)
- `XP` (Число) - Сырой протеин
- `ОЭ` (Число)
- `NEL` (Число)
- `NDF` (Число)
- `ADF` (Число)
- И другие показатели согласно существующей структуре

**Примечание:** Согласно коду, структура уже используется корректно.

---

## 6. Справочник `ПоказателиРационов`

### 6.1. Предопределенные элементы

Убедиться, что существуют следующие предопределенные элементы с правильными именами:

- `СухоеВещество` - Сухое вещество (приоритет 1)
- `XP` - СП (Сырой протеин) (приоритет 2)
- `СВВОК` - СВ в ОК (приоритет 3)
- `Влажность` - Влажность (приоритет 4)
- `NEL` - NEL
- `NDF_ОК` - NDF (ОК)
- Другие показатели...

### 6.2. Реквизиты показателей

Убедиться, что у справочника есть реквизиты:

- `ИмяПредопределенныхДанных` (Строка) - используется в коде для идентификации
- `ПереводитьВПроценты` (Булево) - признак того, что показатель нужно переводить в проценты
- `ЕдиницаИзмерения` (СправочникСсылка.ЕдиницыИзмерения)

---

## 7. Справочник `ЕдиницыИзмерения`

### 7.1. Предопределенные элементы

Убедиться, что существует предопределенный элемент:

- `Процент` - используется для идентификации показателей в процентах

---

## 8. Перечисление `ВидыКормов`

### 8.1. Значения перечисления

Убедиться, что существуют следующие значения:

- `ОК` - Основной корм (используется для расчета СВ в ОК)
- `МК` - Минеральный корм
- `КК` - Концентрированный корм
- `Прочее` - Прочие корма

**Примечание:** Согласно коду, эти значения уже используются.

---

## 9. Права доступа

### 9.1. Роли

Убедиться, что роли `ПолныеПрава` и `Зоотехник` имеют права:

- **Чтение:**
  - Справочник `Рационы`
  - Регистр сведений `ТаблицаПитательностиКормов`
  - Регистр сведений `НормативныеПоказателиРационов`
  - Справочник `ПоказателиРационов`
  - Справочник `ЕдиницыИзмерения`

- **Изменение:**
  - Справочник `Рационы` (для записи результатов авторасчета)

---

## 10. Дополнительные улучшения (опционально)

### 10.1. Индикатор выполнения

Рекомендуется добавить визуализацию длительной операции:

- Использовать `ДлительныеОперации` для фонового выполнения расчета
- Показывать индикатор прогресса во время расчета
- Возможность отмены операции

**Реализация:** Потребует доработки обработчика `РассчитатьАвтоматически` с использованием механизма длительных операций 1С.

### 10.2. История расчетов

Рекомендуется добавить возможность сохранения истории автоматических расчетов:

- Регистр сведений `ИсторияАвтоматическихРасчетовРационов`
- Хранение: дата, пользователь, исходные веса, результаты, количество показателей вне нормы

### 10.3. Настройки алгоритма

Рекомендуется добавить настройки для алгоритма оптимизации:

- Максимальное время расчета (по умолчанию 30 сек)
- Точность расчета (шаг изменения веса)
- Количество итераций

**Реализация:** Можно добавить в регистр сведений `НастройкиСистемы` или константы.

### 10.4. Визуализация результатов

Рекомендуется добавить визуальное выделение:

- Показатели, которые удалось привести в норму - зеленым цветом
- Показатели, которые остались вне нормы - красным цветом (уже реализовано)
- Показатели, которые были вне нормы до расчета, но стали лучше - желтым цветом

---

## 11. Тестирование

### 11.1. Сценарии тестирования

После внесения изменений рекомендуется протестировать:

1. **Базовый сценарий:**
   - Создать рацион с несколькими кормами
   - Заполнить МинимальныйВес и МаксимальныйВес
   - Запустить авторасчет
   - Проверить, что веса изменились и показатели пересчитались

2. **Проверка валидации:**
   - Попытаться запустить авторасчет без заполнения МинимальныйВес/МаксимальныйВес
   - Попытаться запустить с МинимальныйВес > МаксимальныйВес
   - Проверить корректность сообщений об ошибках

3. **Проверка оптимизации:**
   - Создать рацион, где точная балансировка невозможна
   - Проверить, что алгоритм находит компромиссное решение
   - Проверить корректность сообщения о количестве показателей вне нормы

4. **Проверка производительности:**
   - Создать рацион с 20 кормами
   - Проверить, что расчет выполняется за приемлемое время (до 30 сек)

5. **Проверка прав доступа:**
   - Проверить видимость команды "Авторасчет" для разных ролей
   - Проверить, что пользователи без прав не могут запустить расчет

---

## 12. Известные ограничения

### 12.1. Ограничения реализованного алгоритма

1. **Локальный минимум:** Метод покоординатного спуска может найти локальный, а не глобальный минимум. Для улучшения можно запускать алгоритм с разными начальными значениями.

2. **Время расчета:** При большом количестве кормов (более 20) и показателей расчет может занять больше времени. Рекомендуется использовать механизм длительных операций.

3. **Сложные ограничения:** Алгоритм не учитывает сложные взаимосвязи между показателями (например, нелинейные зависимости).

### 12.2. Планы по улучшению

1. Реализовать более продвинутые алгоритмы оптимизации (генетические алгоритмы, симплекс-метод)
2. Добавить возможность задания весовых коэффициентов для показателей
3. Реализовать множественный запуск с разными начальными условиями
4. Добавить анализ чувствительности решения

---

**Примечание:** Все изменения в коде (модули форм и общих модулей) уже реализованы. Данные рекомендации касаются только изменений в XML метаданных и форм, которые должны быть внесены через конфигуратор 1С.

---

## 13. История изменений

### 2026-01-18 - Корректировка алгоритма расчета показателей

**Изменения в общем модуле `РасчетРационов`:**

1. **Функция `РассчитатьПоказателиПитательности` полностью переработана** в соответствии с оригинальной логикой из формы элемента справочника Рационы:

   - Реализована двухпроходная обработка показателей (сначала все кроме СухоеВещество, потом СухоеВещество)
   - Добавлена поддержка специальных показателей:
     - `NDF_ОК` - использует колонку NDF и фильтрует только по виду корма ОК
     - `РастворимыйСП` и `РастворимыйВРубцеПротеин` - расчет по формуле: XP * РастворимыйСП / 100 * СухоеВещество / 1000
     - `НерастворимыйВРубцеПротеин` - расчет по формуле: XP * (100 - РастворимыйСП) / 100 * СухоеВещество / 1000
   
   - Реализован расчет накопления СВ по видам корма (ОК, МК, КК, Прочее)
   
   - Добавлена постобработка показателей:
     - `NELНаКгСВ` = 1000 * NEL / СуммаСВ
     - `DCAD` = 100 * (Na*434 + K*256 - Cl*282 - S*624) / (СуммаСВ - СуммаСВ_МК)
     - `Ca_P` = Ca / P
     - `СВВОК` в процентах = 100 * СуммаСВ_ОК / СуммаСВ
     - `Влажность` в процентах = 100 - 100 * СуммаСВ / ОбщийВес
     - `РастворимыйСП` в процентах = 100 * РастворимыйСП / XP
     - Остальные показатели в процентах = 100 * Показатель / СуммаСВ

2. **Добавлена вспомогательная функция `ПолучитьЗначениеПоказателя`** для безопасного получения значений показателей из соответствия.

3. **Оптимизирован алгоритм оптимизации** в функции `ВыполнитьОптимизациюПокоординатнымСпуском`:
   - Удален лишний цикл по показателям
   - Целевая функция учитывает все показатели с приоритетами одновременно через взвешенные коэффициенты

**Важно:** Эта корректировка обеспечивает полную совместимость алгоритма авторасчета с существующей логикой расчета показателей питательности в системе.

### 2026-01-18 - Исправление архитектуры передачи данных между клиентом и сервером

**Проблема:** Таблица значений не может передаваться между клиентом и сервером в 1С.

**Решение:**

1. **Серверная функция `ВыполнитьАвтоматическуюОптимизациюНаСервере` переработана:**
   - Теперь полностью выполняется на сервере
   - Применяет результаты оптимизации напрямую к `Объект.Корма` на сервере
   - Выполняет пересчет показателей питательности на сервере
   - Возвращает на клиент только структуру с простыми типами данных (Число, Строка, Булево):
     * `Успех` (Булево)
     * `КоличествоПоказателейВнеНормы` (Число)
     * `ОбщееКоличествоПоказателей` (Число)
     * `ВремяРасчета` (Число)
     * `ТекстОшибки` (Строка)

2. **Клиентская процедура `РассчитатьАвтоматически` упрощена:**
   - Выполняет только быструю клиентскую валидацию диапазонов веса
   - Вызывает серверную функцию
   - Обновляет интерфейс после успешного выполнения
   - Отображает результаты пользователю

**Преимущества:**
- Корректная архитектура клиент-сервер в 1С
- Минимизация объема данных, передаваемых между клиентом и сервером
- Атомарность операции - все изменения применяются на сервере
- Повышение производительности

### 2026-01-18 - Оптимизация к целевому значению (оптимуму)

**Требование:** Алгоритм должен стремиться к оптимальному значению показателя, которое находится в середине диапазона [минимум; максимум], а не просто попадать в диапазон.

**Реализация:**

1. **Расчет оптимума** в функции `ПодготовитьМассивПоказателей`:
   - Для каждого показателя рассчитывается оптимальное значение:
     - Если заполнены и минимум, и максимум: `Оптимум = (Минимум + Максимум) / 2`
     - Если заполнен только минимум: `Оптимум = Минимум`
     - Если заполнен только максимум: `Оптимум = Максимум`
   - Примеры:
     - Влажность: диапазон 50-53%, оптимум = 51,5%
     - Сухое вещество: мин=макс=20000, оптимум = 20000
     - Крахмал: диапазон 22-30%, оптимум = 26%

2. **Целевая функция переработана** (`ВычислитьЦелевуюФункцию`):
   - **Отклонение от оптимума**: рассчитывается относительное отклонение от оптимального значения (в процентах)
   - **Штраф за выход за границы**: большой дополнительный штраф (×1000) при выходе за пределы диапазона [минимум с погрешностью; максимум]
   - **Итоговая формула**: `Отклонение = ОтклонениеОтОптимума + ШтрафЗаВыходЗаГраницы`

**Результат:**
- Алгоритм теперь стремится к оптимальному значению в середине диапазона
- Сохраняется приоритетность удержания в допустимых пределах (большой штраф за выход)
- Улучшенное качество балансировки рациона - показатели не просто в диапазоне, а максимально близки к оптимуму

**Пример:** Для влажности с диапазоном 50-53%:
- Старый алгоритм: любое значение 50-53% было одинаково "хорошим"
- Новый алгоритм: стремится к 51,5% (середине диапазона)

### 2026-01-18 - Исправление алгоритма: жёсткие ограничения и улучшенная оптимизация

**Проблема:** Алгоритм не достигал целевого значения сухого вещества (20 000 г), застревая на минимальных весах кормов (17 614 г вместо 20 000 г).

**Корневая причина:**
1. Показатели с Минимум = Максимум (жёсткие ограничения) обрабатывались так же, как диапазоны
2. Алгоритм оптимизации был недостаточно агрессивным для выхода из локальных минимумов

**Реализованные исправления:**

1. **Жёсткие ограничения** (где Минимум = Максимум):
   - Добавлен признак `ЖесткоеОграничение`
   - Штраф за отклонение увеличен в 100 раз: `×10000` вместо `×100`
   - Примеры жёстких ограничений:
     - Сухое вещество: мин=макс=20000 г
     - Соль, сода, премикс: фиксированные значения

2. **Улучшенный алгоритм оптимизации:**
   - Увеличено количество итераций: **100 → 300**
   - Добавлены множественные шаги поиска: `×1, ×2, ×0.5` для более гибкого движения
   - Улучшенный начальный шаг: **0.1 → 0.2 кг**
   - Уменьшен минимальный шаг: **0.01 → 0.005 кг** (5 грамм точность)
   - Адаптивное уменьшение шага: только после 3 итераций без улучшения

3. **Усиленные штрафы за выход за границы:**
   - Для диапазонов: штраф увеличен с `×1000` до `×5000`
   - Это обеспечивает приоритет удержания в допустимых пределах

**Результат:**
- Алгоритм теперь корректно достигает жёстких ограничений (например, 20 000 г сухого вещества)
- Более эффективный поиск оптимального решения
- Лучшая балансировка между жёсткими ограничениями и мягкими диапазонами

### 2026-01-18 - Критический приоритет для Сухого вещества

**Проблема:** Даже после усиления штрафов алгоритм давал 17 614 г вместо требуемых 20 000 г.

**Решение:** Добавлен **дополнительный множитель ×10** специально для показателя "Сухое вещество":

```bsl
// Сухое вещество - критически важный показатель, штраф увеличен в 10 раз
Если ИмяПоказателя = "СухоеВещество" Тогда
    Отклонение = Отклонение * 10;
КонецЕсли;
```

**Итоговый штраф для Сухого вещества:**
- Жёсткое ограничение: базовый штраф `×10000`
- Дополнительный множитель: `×10`
- Коэффициент приоритета: `×100` (приоритет = 1)
- **Итого: в 10 раз больше, чем для других показателей**

Это обеспечивает абсолютный приоритет достижения точного значения Сухого вещества = 20 000 г.
