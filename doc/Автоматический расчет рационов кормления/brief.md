# Бриф: Автоматический расчет рационов кормления (Авторацион)

---

## Описание задачи

Необходимо разработать функционал автоматического расчета количества кормов в рационе на основе нормативных показателей питательности.

**Контекст:** В настоящее время пользователь вручную задает количество кормов (в кг) для составления рациона кормления животных. Программа рассчитывает показатели питательности на основе заданного количества и сравнивает их с нормативными значениями (мин/макс). Если показатель не входит в диапазон мин/макс, он отображается красным цветом, что сигнализирует о несоответствии нормативу.

**Проблема:** Ручной подбор количества кормов для балансировки всех показателей питательности в пределах нормативов является трудоемким процессом, требующим многократных итераций.

---

## Цель доработки

Автоматизировать процесс балансировки рациона путем автоматического расчета оптимального количества каждого корма, при котором максимальное количество показателей питательности будет находиться в пределах нормативных значений.

---

## Требования к функционалу

### Основные требования

1. **Работа с табличной частью "Корма"**
   - Пользователь задает диапазон допустимого веса для каждого корма в колонках МинимальныйВес, МаксимальныйВес
   - Допускается задание фиксированного веса: МинимальныйВес = МаксимальныйВес (например, премикс 0,1 кг)

2. **Команда "Авторасчет"**
   - При выполнении команды "РассчитатьАвтоматически" запускается алгоритм автоматического расчета количества кормов

3. **Алгоритм автоматического расчета**
   
   **Входные данные:**
   - Список кормов с диапазонами веса (МинимальныйВес, МаксимальныйВес)
   - Показатели питательности каждого корма из регистра сведений `ТаблицаПитательностиКормов`
   - Нормативные значения показателей (мин/макс) из табличной части `ПоказателиРациона`
   
   **Задача:**
   - Рассчитать количество (вес) каждого корма в пределах заданных диапазонов
   - Минимизировать отклонения фактических показателей питательности от нормативных значений
   - Учитывать приоритетность показателей (см. ниже)
   
   **Ограничения:**
   - Вес каждого корма должен быть в диапазоне [МинимальныйВес; МаксимальныйВес]
   - Все корма, указанные в табличной части, обязательны (должны присутствовать в расчете)
   - Для всех показателей допускается погрешность -5% от нормативных значений
   
   **Приоритет показателей (строгая очередность):**
   1. Сухое вещество (наивысший приоритет)
   2. СП (сырой протеин)
   3. СВ в ОК
   4. Влажность
   5. Остальные показатели (находятся в диапазоне, легко балансируются)
   
   **Выходные данные:**
   - Рассчитанное количество (вес в кг) для каждого корма в табличной части
   - Если идеального решения не существует, находить решение с минимальным количеством отклонений, учитывая приоритет показателей

4. **Требования к производительности**
   - Время расчета не должно превышать 30 секунд
   - Обычное количество кормов в рационе: до 20 штук

5. **Поведение при невозможности точной балансировки**
   - Предполагается, что идеального рациона (все показатели в норме) может не существовать
   - Алгоритм должен найти решение с минимальным количеством отклонений от нормативов
   - Показатели, выходящие за пределы нормативов, продолжают отображаться красным цветом
   - Пользователь может вручную скорректировать диапазоны МинимальныйВес/МаксимальныйВес и повторить расчет

---

## Затронутые объекты метаданных 1С

### Справочники
- **`Рационы`** (`Долома\src\Catalogs\Рационы`)
  - Табличная часть `Корма` — используются реквизиты:
    - `МинимальныйВес` (Число, 10.2, кг)
    - `МаксимальныйВес` (Число, 10.2, кг)
  - Табличная часть `ПоказателиРациона` — используется для хранения нормативных значений показателей
  - Форма элемента — запуск авторасчета по команде "Авторасчет"

- **`ПоказателиРационов`** (`Долома\src\Catalogs\ПоказателиРационов`)
  - Используется для определения списка показателей питательности
  - Содержит реквизит `ЕдиницаИзмерения`

### Регистры сведений
- **`НормативныеПоказателиРационов`** (`Долома\src\InformationRegisters\НормативныеПоказателиРационов`)
  - Источник данных для заполнения табличной части `ПоказателиРациона`
  - Содержит нормативные значения (мин/макс) для показателей

- **`ТаблицаПитательностиКормов`** (`Долома\src\InformationRegisters\ТаблицаПитательностиКормов`)
  - Содержит значения показателей питательности для каждого корма
  - Используется для расчета фактических показателей рациона

### Общие модули
- Используется общий модуль с алгоритмом расчета: `Долома\src\CommonModules\РасчетРационов`

---

## Алгоритм выполнения

### 1. Подготовка данных
1.1. Получить список кормов из табличной части `Корма` с диапазонами веса  
1.2. Для каждого корма получить показатели питательности из регистра `ТаблицаПитательностиКормов`  
1.3. Получить нормативные показатели из табличной части `ПоказателиРациона`  
1.4. Проверить корректность данных:
   - МинимальныйВес ≤ МаксимальныйВес для всех кормов
   - Наличие показателей питательности для всех кормов
   - Наличие нормативных значений

### 2. Выполнение расчета

**Рекомендуемый подход:** Последовательная оптимизация по приоритетам с использованием метода линейного программирования.

**Этапы расчета:**

2.1. **Инициализация**
   - Установить начальные значения веса кормов (например, средние значения диапазонов)

2.2. **Оптимизация по приоритетным показателям**

Для каждого показателя в порядке приоритета:

   **Шаг 1: Сухое вещество**
   - Минимизировать отклонение показателя от целевого диапазона [мин; макс]
   - Учитывать погрешность -5%
   - Ограничения: веса кормов в пределах [МинимальныйВес; МаксимальныйВес]
   - Зафиксировать найденное решение как базовое

   **Шаг 2: СП (сырой протеин)**
   - Оптимизировать отклонение СП от нормы
   - Не ухудшать результат по Сухому веществу (мягкое ограничение)
   - Если оптимизация невозможна без ухудшения Сухого вещества — допустить минимальное ухудшение

   **Шаг 3: СВ в ОК**
   - Оптимизировать СВ в ОК
   - Приоритет: Сухое вещество > СП > СВ в ОК

   **Шаг 4: Влажность**
   - Оптимизировать Влажность
   - Приоритет: Сухое вещество > СП > СВ в ОК > Влажность

   **Шаг 5: Остальные показатели**
   - Попытаться сбалансировать оставшиеся показатели
   - Не ухудшать приоритетные показатели

2.3. **Проверка решения**
   - Рассчитать итоговые показатели питательности
   - Проверить соответствие нормативам с учетом погрешности -5%
   - Подсчитать количество отклонений

### 3. Применение результата
3.1. Записать рассчитанные значения веса в табличную часть `Корма`  
3.2. Пересчитать показатели рациона  
3.3. Обновить отображение (красным цветом показатели вне нормы)  
3.4. Предполагается, что показать пользователю информационное сообщение о результате расчета (например: "Расчет выполнен. Показатели вне нормы: 2 из 15")

---

## Технические детали

### Единицы измерения
- Вес кормов: килограммы (кг)
- Показатели питательности: определяются реквизитом `ЕдиницаИзмерения` в табличной части `ПоказателиРациона`

### Погрешность расчета
- Для всех показателей допускается погрешность -5% от нормативных значений
- Это означает: если норма мин = 10, макс = 15, то допустимо:
  - минимум: 10 - 5% = 9.5
  - максимум: 15 (без увеличения)
- Предполагается, что погрешность применяется только к нижней границе

### Математический метод

**Рекомендация:** Использовать метод последовательного квадратичного программирования (Sequential Quadratic Programming, SQP) или симплекс-метод с приоритизацией целевых функций.

**Обоснование:**
- Задача является задачей многокритериальной оптимизации с ограничениями
- Количество переменных (до 20) позволяет использовать классические методы оптимизации
- Строгая приоритетность показателей требует последовательного подхода
- Время расчета до 30 секунд достаточно для выполнения нескольких итераций оптимизации

**Альтернативный подход:** Если встроенные средства 1С или доступные библиотеки не поддерживают методы линейного программирования, можно использовать:
- Генетический алгоритм с взвешенной функцией приспособленности
- Метод градиентного спуска с штрафными функциями
- Метод покоординатного спуска с приоритизацией

---

## Ограничения и допущения

### Ограничения

1. **Производительность**
   - Максимальное время расчета: 30 секунд
   - Типичное количество кормов: до 20 штук
   - Если расчет превышает 30 секунд — прервать и вернуть лучшее найденное решение

2. **Обязательность кормов**
   - Все корма, указанные пользователем в табличной части, должны присутствовать в решении
   - Нельзя исключать корма из расчета

3. **Диапазоны веса**
   - Веса кормов должны строго соответствовать заданным диапазонам [МинимальныйВес; МаксимальныйВес]
   - Выход за пределы диапазона недопустим даже для улучшения балансировки

### Допущения

1. **Погрешность нормативов**
   - Предполагается, что погрешность -5% применяется к нижней границе нормативных значений
   - Если требуется другая интерпретация (например, ±5% к обеим границам), необходимо уточнение у постановщиков

2. **Невозможность идеального решения**
   - Принимаем допущение, что в большинстве случаев найти решение со всеми показателями в норме невозможно из-за ограничений по весу кормов
   - Алгоритм находит наилучшее компромиссное решение с минимальным количеством отклонений

3. **Отображение результата**
   - Предполагается, что механизм отображения показателей красным цветом (при отклонении от нормы) уже реализован в текущей системе
   - Алгоритм автоматического расчета не изменяет эту логику

4. **Расчет показателей питательности**
   - Предполагается, что расчет показателей рациона на основе весов и питательности кормов уже реализован в системе
   - Формула расчета: линейная комбинация (сумма произведений веса корма на его показатель питательности)

5. **Доступность данных**
   - Предполагается, что для всех кормов в рационе заполнены показатели питательности в регистре `ТаблицаПитательностиКормов`
   - Если данные отсутствуют — показать предупреждение и прервать расчет

---

## Риски и ограничения

1. **Отсутствие решения**
   - Риск: При узких диапазонах МинимальныйВес/МаксимальныйВес может не существовать решения даже с отклонениями
   - Митигация: Информировать пользователя о невозможности расчета и предложить расширить диапазоны

2. **Производительность**
   - Риск: Расчет может занять более 30 секунд при большом количестве кормов и показателей
   - Митигация: Оптимизация алгоритма, возможность прерывания расчета с возвратом промежуточного результата

3. **Сложность алгоритма**
   - Риск: Реализация методов оптимизации в 1С может быть нетривиальной
   - Митигация: Использование внешних компонент или упрощенных эвристических алгоритмов

4. **Качество решения**
   - Риск: Найденное решение может быть неоптимальным (локальный минимум)
   - Митигация: Запуск алгоритма с разными начальными условиями и выбор лучшего результата

---

## Вопросы для уточнения у постановщиков

*На данный момент все критичные вопросы получили ответы. Дополнительные вопросы могут возникнуть в процессе разработки технического задания.*

---

*Дата создания брифа: 2026-01-16*  
*Версия: 1.0*
