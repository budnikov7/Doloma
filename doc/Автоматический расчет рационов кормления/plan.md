# План реализации: Автоматический расчет рационов кормления

## Объекты/модули для изменения

1. **Справочник `Рационы`** (`Долома\src\Catalogs\Рационы`)
   - Форма элемента: реализация существующего обработчика команды "РассчитатьАвтоматически", добавление индикатора выполнения

2. **Общий модуль `РасчетРационов`** (`Долома\src\CommonModules\РасчетРационов`)
   - Расширение функционала существующего модуля
   - Реализация алгоритма автоматической оптимизации рациона

3. **Регистры сведений** (чтение данных):
   - `ТаблицаПитательностиКормов` — получение показателей питательности кормов
   - `НормативныеПоказателиРационов` — получение нормативных значений

---

## План реализации (6 шагов)

### Шаг 1. Реализация обработчика команды в форме
- Заполнить существующий обработчик `РассчитатьАвтоматически` в форме элемента
- Добавить показ индикатора выполнения (длительная операция)
- Проверить корректность заполнения МинимальныйВес/МаксимальныйВес перед запуском
- Вызов серверной функции оптимизации с передачей данных объекта

### Шаг 2. Подготовка входных данных для алгоритма
- Реализовать функцию сбора кормов с диапазонами веса из табличной части Корма
- Получить показатели питательности для каждого корма из регистра ТаблицаПитательностиКормов
- Получить нормативные значения показателей из табличной части ПоказателиРациона
- Валидация данных: проверка корректности диапазонов, наличия показателей, непустые нормативы

### Шаг 3. Реализация алгоритма оптимизации в общем модуле
- Создать функцию автоматической оптимизации в модуле РасчетРационов
- Использовать метод покоординатного спуска с приоритизацией показателей
- Последовательная оптимизация: Сухое вещество → СП → СВ в ОК → Влажность → остальные показатели
- Учет погрешности -5% для нижней границы нормативов
- Ограничение времени расчета 30 секундами с возвратом лучшего найденного решения

### Шаг 4. Расчет и оценка решения
- Функция расчета фактических показателей питательности на основе весов кормов (использовать существующую логику)
- Вычисление целевой функции (количество и величина отклонений от нормативов)
- Подсчет показателей вне допустимого диапазона с учетом приоритетов

### Шаг 5. Применение результата и обновление интерфейса
- Запись рассчитанных значений веса в колонку Вес табличной части Корма
- Автоматический пересчет показателей рациона (вызов существующей процедуры РассчитатьПоказателиПитательности)
- Вывод информационного сообщения о результате: количество показателей вне нормы, время расчета

### Шаг 6. Обработка исключительных ситуаций
- Обработка случаев отсутствия данных (показатели питательности, нормативы)
- Обработка некорректных диапазонов (МинимальныйВес > МаксимальныйВес)
- Прерывание расчета по таймауту (30 сек) с возвратом промежуточного результата
- Информирование пользователя при невозможности найти приемлемое решение

---

## Алгоритм оптимизации (краткое описание)

**Метод:** Покоординатный спуск с приоритизацией

**Этапы:**
1. Инициализация весов кормов средними значениями диапазонов
2. Для каждого приоритетного показателя:
   - Оптимизация веса каждого корма поочередно для минимизации отклонения
   - Итеративная корректировка с учетом ограничений диапазонов
   - Фиксация улучшения, если показатель вошел в норму
3. Проверка таймаута после каждой итерации
4. Возврат лучшего найденного решения

**Целевая функция:** Взвешенная сумма отклонений от нормативов с коэффициентами по приоритетам

---

*Дата создания плана: 2026-01-18*  
*Версия: 1.0*
